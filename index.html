<!doctype html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Quản Lý Công Nợ</title>

<script src="/_sdk/data_sdk.js"></script>
<script src="/_sdk/element_sdk.js"></script>

<style>
body{font-family:'Times New Roman',serif;background:#f3e5f5;margin:0}
.container{padding:30px}
.content-wrapper{background:#fff;padding:30px;border-radius:10px}
input,select,button{padding:8px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#64b5f6;color:white}
.btn-add{background:#42a5f5;color:white;border:none;cursor:pointer}
.btn-delete{background:#ef5350;color:white;border:none;cursor:pointer}
.total{margin-top:15px;font-weight:bold;text-align:right}
</style>
</head>

<body>
<div class="container">
<div class="content-wrapper">

<h2 style="text-align:center">CÔNG NỢ CHI TIẾT</h2>

<form id="entry-form">
  <input type="date" id="ngay" required>
  <select id="ten-hang" required>
    <option value="">-- Tên hàng --</option>
    <option value="Cá Chạch Lấu">Cá Chạch Lấu</option>
    <option value="Cá Tôm">Cá Tôm</option>
  </select>
  <input type="number" id="so-luong" placeholder="Số lượng" step="0.01" required>
  <input type="number" id="don-gia" placeholder="Đơn giá" required>
  <button type="submit" class="btn-add" id="btn-add">Thêm vào bảng</button>
</form>

<br>

<table>
<thead>
<tr>
  <th>Ngày</th>
  <th>Tên hàng</th>
  <th>Số lượng</th>
  <th>Đơn giá</th>
  <th>Thành tiền</th>
  <th>Xóa</th>
</tr>
</thead>
<tbody id="table-body">
<tr class="empty">
<td colspan="6">Chưa có dữ liệu</td>
</tr>
</tbody>
</table>

<div class="total">
Tổng cộng: <span id="total-amount">0</span> đ
</div>

</div>
</div>

<script>
let records = [];
let isLoading = false;

/* ================= KHỞI TẠO DATA SDK ================= */
const dataHandler = {
  onDataChanged(data){
    records = data || [];
    renderTable();
    updateTotal();
  }
};

async function init(){
  document.getElementById("entry-form")
    .addEventListener("submit", handleSubmit);

  if(window.dataSdk){
    await window.dataSdk.init(dataHandler);
  }
}
init();

/* ================= THÊM DỮ LIỆU ================= */
async function handleSubmit(e){
  e.preventDefault();
  if(isLoading) return;

  const ngay = ngayInput().value;
  const tenHang = tenHangInput().value;
  const soLuong = parseFloat(soLuongInput().value);
  const donGia = parseFloat(donGiaInput().value);

  if(!ngay || !tenHang || isNaN(soLuong) || isNaN(donGia)){
    alert("Nhập đầy đủ dữ liệu");
    return;
  }

  const thanhTien = soLuong * donGia;

  const newRecord = {
    ngay,
    ten_hang: tenHang,
    so_luong: soLuong,
    don_gia: donGia,
    thanh_tien: thanhTien,
    __backendId: Date.now().toString()
  };

  isLoading = true;
  document.getElementById("btn-add").textContent = "Đang xử lý...";

  /* ✅ THÊM NGAY ĐỂ HIỂN THỊ */
  records.push(newRecord);
  renderTable();
  updateTotal();

  /* Đồng bộ lên Data SDK (nếu có) */
  if(window.dataSdk){
    await window.dataSdk.create(newRecord);
  }

  resetForm();
  isLoading = false;
  document.getElementById("btn-add").textContent = "Thêm vào bảng";
}

/* ================= RENDER BẢNG ================= */
function renderTable(){
  const tbody = document.getElementById("table-body");

  if(records.length === 0){
    tbody.innerHTML =
      `<tr class="empty"><td colspan="6">Chưa có dữ liệu</td></tr>`;
    return;
  }

  tbody.innerHTML = records.map(r=>`
    <tr>
      <td>${formatDate(r.ngay)}</td>
      <td>${r.ten_hang}</td>
      <td>${r.so_luong}</td>
      <td>${formatNumber(r.don_gia)}</td>
      <td>${formatNumber(r.thanh_tien)}</td>
      <td>
        <button class="btn-delete"
          onclick="deleteRow('${r.__backendId}')">X</button>
      </td>
    </tr>
  `).join("");
}

/* ================= XÓA ================= */
async function deleteRow(id){
  records = records.filter(r=>r.__backendId !== id);
  renderTable();
  updateTotal();

  if(window.dataSdk){
    const rec = records.find(r=>r.__backendId===id);
    if(rec) await window.dataSdk.delete(rec);
  }
}

/* ================= TỔNG ================= */
function updateTotal(){
  const total = records.reduce((s,r)=>s+r.thanh_tien,0);
  document.getElementById("total-amount").textContent =
    formatNumber(total);
}

/* ================= HỖ TRỢ ================= */
function formatNumber(n){
  return new Intl.NumberFormat("vi-VN").format(n);
}
function formatDate(d){
  const x=new Date(d);
  return x.toLocaleDateString("vi-VN");
}
function resetForm(){
  ngayInput().value="";
  tenHangInput().value="";
  soLuongInput().value="";
  donGiaInput().value="";
}
const ngayInput=()=>document.getElementById("ngay");
const tenHangInput=()=>document.getElementById("ten-hang");
const soLuongInput=()=>document.getElementById("so-luong");
const donGiaInput=()=>document.getElementById("don-gia");
</script>

</body>
</html>
